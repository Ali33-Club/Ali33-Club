<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHÃ€O Má»ªNG Báº N Äáº¾N Vá»šI CLB PICKLEBALL ALI33 - VIá»†T TRÃŒ</title>
<style>
:root {
  --color-primary: #208791;
  --color-primary-hover: #186e7e;
  --color-primary-active: #157170;
  --color-text: #134252;
  --color-text-secondary: #626c7c;
  --color-bg: #fcfcf9;
  --color-surface: #fffffe;
  --color-border: rgba(94, 82, 64, 0.2);
  --color-success: #22c75a;
  --color-error: #c0152f;
  --color-warning: #a84b2f;
  --radius: 8px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  padding: 16px;
  line-height: 1.5;
}

.container { max-width: 700px; margin: 0 auto; }

header {
  text-align: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--color-primary);
}

header h1 { font-size: 24px; color: var(--color-primary); margin-bottom: 4px; }

header p { color: var(--color-text-secondary); font-size: 14px; }

.sync-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: rgba(34, 199, 90, 0.1);
  border: 1px solid rgba(34, 199, 90, 0.3);
  border-radius: var(--radius);
  margin-bottom: 16px;
  font-size: 12px;
  color: #1a8a3a;
}

.sync-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c75a;
}

.sync-status.loading {
  background: rgba(168, 75, 47, 0.1);
  border-color: rgba(168, 75, 47, 0.3);
  color: #a84b2f;
}

.sync-status.loading .sync-indicator {
  background: #a84b2f;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--color-border);
  overflow-x: auto;
}

.tab-btn {
  padding: 12px 16px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--color-text-secondary);
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 150ms;
  white-space: nowrap;
}

.tab-btn.active {
  color: var(--color-primary);
  border-bottom-color: var(--color-primary);
}

.tab-content { display: none; }

.tab-content.active { display: block; }

.form-group { margin-bottom: 16px; }

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 14px;
  color: var(--color-text);
}

input, select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  font-size: 14px;
  font-family: inherit;
  color: var(--color-text);
  background: var(--color-surface);
}

input:focus, select:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(32, 135, 145, 0.15);
}

.btn {
  width: 100%;
  padding: 12px 16px;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 150ms;
  margin-top: 8px;
}

.btn:hover { background: var(--color-primary-hover); }

.btn.success { background: var(--color-success); }

.btn.success:hover { background: #1a8a3a; }

.btn.danger { background: var(--color-error); }

.btn.danger:hover { background: #a0121f; }

.btn.warning { background: var(--color-warning); }

.btn.warning:hover { background: #974325; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.row .form-group { margin-bottom: 0; }

.member-list { margin-top: 16px; }

.member-item {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.member-name { font-weight: 600; }

.member-badge {
  display: inline-block;
  padding: 4px 12px;
  background: rgba(32, 135, 145, 0.1);
  color: var(--color-primary);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  margin-left: 8px;
}

.member-badge.guest {
  background: rgba(165, 75, 47, 0.1);
  color: #a84b2f;
}

.delete-btn {
  background: var(--color-error);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background 150ms;
}

.delete-btn:hover { background: #a0121f; }

.match-item {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.match-info { flex: 1; }

.match-players { font-weight: 600; margin-bottom: 4px; font-size: 14px; }

.match-score { font-size: 12px; color: var(--color-text-secondary); }

.payment-item {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.payment-name { font-weight: 600; font-size: 16px; }

.money {
  font-weight: 600;
  font-family: 'Courier New', monospace;
}

.money.positive { color: var(--color-success); }

.money.negative { color: var(--color-error); }

.total-payment {
  background: rgba(32, 135, 145, 0.1);
  border: 2px solid var(--color-primary);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
  margin-top: 20px;
}

.total-payment-label { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 8px; }

.total-payment-value { font-size: 32px; font-weight: 700; color: var(--color-primary); font-family: 'Courier New', monospace; }

.ranking-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  border-radius: var(--radius);
  overflow: hidden;
}

.ranking-table thead {
  background: var(--color-primary);
  color: white;
}

.ranking-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 14px;
}

.ranking-table td {
  padding: 12px;
  border-bottom: 1px solid var(--color-border);
  font-size: 14px;
}

.ranking-table tbody tr:hover { background: rgba(32, 135, 145, 0.05); }

.rank-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: var(--color-primary);
  color: white;
  border-radius: 50%;
  font-weight: 600;
  font-size: 14px;
}

.rank-1 { background: #ffd700; color: #333; }

.rank-2 { background: #c0c0c0; color: #333; }

.rank-3 { background: #cd7f32; color: white; }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--color-text-secondary);
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 16px;
  border-radius: var(--radius);
  color: white;
  animation: slideIn 0.3s ease;
  z-index: 1000;
  max-width: 300px;
  font-size: 14px;
}

.notification.success { background: var(--color-success); }

.notification.error { background: var(--color-error); }

.notification.info { background: var(--color-primary); }

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

h2 { font-size: 18px; margin-top: 16px; margin-bottom: 12px; color: var(--color-text); }

h3 { font-size: 14px; margin: 16px 0 8px 0; color: var(--color-text); }

.payment-date-header {
  font-size: 16px;
  font-weight: 600;
  color: var(--color-primary);
  margin: 16px 0 12px 0;
}

.info-text { font-size: 12px; color: var(--color-text-secondary); margin-top: 8px; }

.optional-label {
  display: inline-block;
  padding: 2px 8px;
  background: rgba(32, 135, 145, 0.1);
  color: var(--color-primary);
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
  margin-left: 6px;
}

</style>
</head>
<body>
<div class="container">

<header>
<h1>ğŸ“ Quáº£n LÃ½ CLB Ali33 Pickleball</h1>
<p>Báº£ng tÃ­nh tiá»n vÃ  xáº¿p háº¡ng cá»§a CLB</p>
</header>

<div class="sync-status" id="syncStatus">
<span class="sync-indicator"></span>
<span id="syncText">Sáºµn sÃ ng Ä‘á»“ng bá»™</span>
</div>

<div class="tabs">
<button class="tab-btn active" onclick="switchTab(event, 'members')">ğŸ‘¥ VÄV</button>
<button class="tab-btn" onclick="switchTab(event, 'schedule')">ğŸ“… Lá»‹ch</button>
<button class="tab-btn" onclick="switchTab(event, 'matches')">ğŸ¾ Tráº­n</button>
<button class="tab-btn" onclick="switchTab(event, 'payment')">ğŸ’³ Tiá»n</button>
<button class="tab-btn" onclick="switchTab(event, 'ranking-money')">ğŸ’° BXH Tiá»n</button>
<button class="tab-btn" onclick="switchTab(event, 'ranking-skill')">â­ BXH TrÃ¬nh</button>
<button class="tab-btn" onclick="switchTab(event, 'ranking-score')">ğŸ† BXH Äiá»ƒm</button>
<button class="tab-btn" onclick="switchTab(event, 'backup')">ğŸ’¾ Backup</button>
<button class="tab-btn" onclick="switchTab(event, 'settings')">ğŸ” CÃ i Äáº·t</button>
</div>

<!-- Tab VÄV -->
<div id="members" class="tab-content active">
<h2>â• ThÃªm ThÃ nh ViÃªn/KhÃ¡ch</h2>
<div class="row">
<div class="form-group">
<label>TÃªn VÄV</label>
<input type="text" id="memberName" placeholder="Nháº­p tÃªn">
</div>
<div class="form-group">
<label>Loáº¡i</label>
<select id="memberType">
<option value="club">ThÃ nh ViÃªn CLB</option>
<option value="guest">KhÃ¡ch</option>
</select>
</div>
</div>
<button class="btn" onclick="addMember()">â• ThÃªm VÄV</button>

<h2>ğŸ‘¥ Danh SÃ¡ch ThÃ nh ViÃªn</h2>
<div class="member-list" id="membersList"></div>
</div>

<!-- Tab Lá»‹ch Sinh Hoáº¡t -->
<div id="schedule" class="tab-content">
<h2>ğŸ“… ThÃªm Lá»‹ch Sinh Hoáº¡t</h2>
<div class="row">
<div class="form-group">
<label>NgÃ y Sinh Hoáº¡t (dd/mm/yyyy)</label>
<input type="text" id="scheduleDate" placeholder="01/12/2025">
</div>
<div class="form-group" style="grid-column: 1 / -1;">
<label>Ghi ChÃº (tÃ¹y chá»n)</label>
<input type="text" id="scheduleNote" placeholder="VÃ­ dá»¥: VÃ²ng 1, BÃ¡n káº¿t...">
</div>
</div>
<button class="btn" onclick="addSchedule()">ğŸ“… ThÃªm NgÃ y</button>

<h2>Danh SÃ¡ch Lá»‹ch Sinh Hoáº¡t</h2>
<div class="member-list" id="scheduleList"></div>
</div>

<!-- Tab Tráº­n Äáº¥u -->
<div id="matches" class="tab-content">
<h2>ğŸ¾ Ghi Láº¡i Tráº­n Äáº¥u</h2>
<div class="form-group">
<label>Chá»n NgÃ y Sinh Hoáº¡t</label>
<select id="eventDate" onchange="updateMatchForm()">
<option value="">-- Chá»n ngÃ y --</option>
</select>
</div>

<h3>Cáº·p 1 <span class="optional-label">TÃ¹y chá»n</span></h3>
<div class="row">
<div class="form-group">
<label>VÄV 1</label>
<select id="pair1a">
<option value="">-- Chá»n --</option>
</select>
</div>
<div class="form-group">
<label>VÄV 2</label>
<select id="pair1b">
<option value="">-- Chá»n --</option>
</select>
</div>
</div>
<div class="form-group">
<label>Tá»· Sá»‘</label>
<input type="number" id="score1" placeholder="15" min="0">
</div>

<h3>Cáº·p 2 <span class="optional-label">TÃ¹y chá»n</span></h3>
<div class="row">
<div class="form-group">
<label>VÄV 1</label>
<select id="pair2a">
<option value="">-- Chá»n --</option>
</select>
</div>
<div class="form-group">
<label>VÄV 2</label>
<select id="pair2b">
<option value="">-- Chá»n --</option>
</select>
</div>
</div>
<div class="form-group">
<label>Tá»· Sá»‘</label>
<input type="number" id="score2" placeholder="10" min="0">
</div>

<div class="info-text" style="background: rgba(32, 135, 145, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
â„¹ï¸ <strong>Há»— Trá»£ Linh Hoáº¡t:</strong> Má»—i cáº·p cÃ³ thá»ƒ chá»n tá»« 1-2 VÄV. VÃ­ dá»¥: Cáº·p 1 chá»n 1 VÄV, Cáº·p 2 chá»n 2 VÄV...
</div>

<button class="btn" onclick="addMatch()">â• ThÃªm Tráº­n Äáº¥u</button>

<h2>Danh SÃ¡ch Tráº­n Äáº¥u</h2>
<div class="member-list" id="matchList"></div>
</div>

<!-- Tab TÃ­nh Tiá»n -->
<div id="payment" class="tab-content">
<h2>ğŸ’³ Báº£ng TÃ­nh Tiá»n</h2>
<div class="form-group">
<label>Chá»n NgÃ y Sinh Hoáº¡t</label>
<select id="paymentDate" onchange="updatePaymentList()">
<option value="">-- Chá»n ngÃ y --</option>
</select>
</div>
<div id="paymentList"></div>
</div>

<!-- Tab BXH Tiá»n -->
<div id="ranking-money" class="tab-content">
<h2>ğŸ’° Báº£ng Xáº¿p Háº¡ng Tiá»n (NÄƒm DÆ°Æ¡ng Lá»‹ch)</h2>
<table class="ranking-table">
<thead>
<tr>
<th>Háº¡ng</th>
<th>TÃªn VÄV</th>
<th>Tráº­n</th>
<th>Tiá»n (k)</th>
</tr>
</thead>
<tbody id="rankingMoneyBody">
<tr>
<td colspan="4" class="empty-state" style="padding: 40px 20px;">ChÆ°a cÃ³ dá»¯ liá»‡u</td>
</tr>
</tbody>
</table>
</div>

<!-- Tab BXH TrÃ¬nh Äá»™ -->
<div id="ranking-skill" class="tab-content">
<h2>â­ Báº£ng Xáº¿p Háº¡ng TrÃ¬nh Äá»™ (â‰¥5 Tráº­n)</h2>
<table class="ranking-table">
<thead>
<tr>
<th>Háº¡ng</th>
<th>TÃªn VÄV</th>
<th>Tráº­n</th>
<th>Tháº¯ng %</th>
</tr>
</thead>
<tbody id="rankingSkillBody">
<tr>
<td colspan="4" class="empty-state" style="padding: 40px 20px;">ChÆ°a cÃ³ dá»¯ liá»‡u</td>
</tr>
</tbody>
</table>
</div>

<!-- Tab BXH Äiá»ƒm Sá»‘ -->
<div id="ranking-score" class="tab-content">
<h2>ğŸ† Báº£ng Xáº¿p Háº¡ng Äiá»ƒm Sá»‘</h2>
<table class="ranking-table">
<thead>
<tr>
<th>Háº¡ng</th>
<th>TÃªn VÄV</th>
<th>W/L</th>
<th>Äiá»ƒm</th>
<th>Hiá»‡u Sá»‘</th>
</tr>
</thead>
<tbody id="rankingScoreBody">
<tr>
<td colspan="5" class="empty-state" style="padding: 40px 20px;">ChÆ°a cÃ³ dá»¯ liá»‡u</td>
</tr>
</tbody>
</table>
</div>

<!-- Tab CÃ i Äáº·t -->
<div id="settings" class="tab-content">
<h2>ğŸ” CÃ i Äáº·t Báº£o Máº­t</h2>
<div class="form-group">
<label>
<strong>âš ï¸ Cháº¿ Äá»™ Xem (Chá»‰ Äá»c) - LuÃ´n Báº­t</strong>
</label>
<p class="info-text" style="margin-top: 8px;">Cháº¿ Ä‘á»™ xem luÃ´n báº­t. Nháº­p máº­t kháº©u Ä‘á»ƒ táº¡m táº¯t trong 5 phÃºt.</p>
<button class="btn warning" onclick="toggleReadOnlyWithPassword()">ğŸ”“ Táº¯t Cháº¿ Äá»™ Xem (5 phÃºt)</button>
</div>

<div class="info-text" style="margin-top: 20px; background: rgba(192, 21, 47, 0.1); padding: 12px; border-radius: 8px;">
âš ï¸ <strong>Cháº¿ Äá»™ Xem:</strong> Khi báº­t, chá»‰ khÃ³a nÃºt ThÃªm / Ghi / XÃ³a<br>
âš ï¸ <strong>Máº­t Kháº©u:</strong> ÄÆ°á»£c lÆ°u vÃ  Ä‘á»“ng bá»™ trÃªn Cloud Firebase
</div>

<h3 style="margin-top: 30px;">Tráº¡ng ThÃ¡i Hiá»‡n Táº¡i</h3>

<div class="payment-item">
<div class="payment-name">Cháº¿ Äá»™</div>
<div><span id="modeStatus" class="money negative">ğŸ”’ Chá»‰ Xem (Báº­t)</span></div>
</div>

<div class="payment-item">
<div class="payment-name">Äá»“ng Bá»™ Cloud</div>
<div><span id="syncStatus2" class="money positive">âœ“ Tá»± Äá»™ng</span></div>
</div>
</div>

<!-- Tab Backup -->
<div id="backup" class="tab-content">
<h2>ğŸ’¾ Sao LÆ°u & Äá»“ng Bá»™</h2>
<button class="btn success" onclick="toggleAutoSync()" id="autoSyncBtn">ğŸ”„ Tá»± Äá»™ng Äá»“ng Bá»™ Firebase</button>
<button class="btn" onclick="manualSaveFirebase()">ğŸ’¾ LÆ°u LÃªn Firebase Ngay</button>
<button class="btn" onclick="manualLoadFirebase()">ğŸ“¥ Táº£i Tá»« Firebase</button>
<button class="btn" onclick="exportData()">ğŸ“¥ Táº£i Vá» (JSON)</button>
<button class="btn danger" onclick="clearAllData()">ğŸ—‘ï¸ XÃ³a Táº¥t Cáº£</button>

<div class="info-text" style="margin-top: 20px; background: rgba(34, 199, 90, 0.1); padding: 12px; border-radius: 8px;">
âœ“ Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trÃªn mÃ¡y tÃ­nh + Firebase Cloud<br>
âœ“ 100% offline - khÃ´ng cáº§n internet<br>
âœ“ Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ khi cÃ³ thay Ä‘á»•i
</div>
</div>

</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1Zq6yiWwLFzY9w2G2pir_5cvSFtOTjPk",
  authDomain: "ali33-6d285.firebaseapp.com",
  databaseURL: "https://ali33-6d285-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ali33-6d285",
  storageBucket: "ali33-6d285.firebasestorage.app",
  messagingSenderId: "50398279647",
  appId: "1:50398279647:web:6213d0b2e6bfa8fd75366a"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let members = JSON.parse(localStorage.getItem('members')) || [];
let schedules = JSON.parse(localStorage.getItem('schedules')) || [];
let matches = JSON.parse(localStorage.getItem('matches')) || [];
let autoSyncEnabled = true;
let readOnlyMode = true;
let adminPassword = localStorage.getItem('adminPassword') || 'Ali34';

function switchTab(event, tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  if (tabName === 'ranking-money') updateRankingMoney();
  else if (tabName === 'ranking-skill') updateRankingSkill();
  else if (tabName === 'ranking-score') updateRankingScore();
  else if (tabName === 'payment') updatePaymentDropdown();
  else if (tabName === 'settings') updateSettingsUI();
}

function updateSettingsUI() {
  document.getElementById('modeStatus').textContent = readOnlyMode ? 'ğŸ”’ Chá»‰ Xem (Báº­t)' : 'âœï¸ Chá»‰nh Sá»­a (Táº¡m thá»i)';
  document.getElementById('modeStatus').className = readOnlyMode ? 'money negative' : 'money positive';
  document.getElementById('syncStatus2').textContent = 'âœ“ Tá»± Äá»™ng';
  document.getElementById('syncStatus2').className = 'money positive';
}

function toggleReadOnlyWithPassword() {
  const pwd = prompt('Nháº­p máº­t kháº©u admin Ä‘á»ƒ táº¯t cháº¿ Ä‘á»™ xem (30 phÃºt):');
  if (!pwd) return;
  
  if (pwd !== adminPassword) {
    showNotification('Máº­t kháº©u sai!', 'error');
    return;
  }
  
  readOnlyMode = false;
  applyReadOnlyMode();
  updateSettingsUI();
  showNotification('âœ“ Cháº¿ Ä‘á»™ chá»‰nh sá»­a Ä‘Ã£ báº­t trong 30 phÃºt', 'success');
  
  setTimeout(() => {
    readOnlyMode = true;
    applyReadOnlyMode();
    updateSettingsUI();
    showNotification('â±ï¸ ÄÃ£ quay láº¡i cháº¿ Ä‘á»™ chá»‰ xem', 'info');
    autoSync();
  }, 1800000);
}

function applyReadOnlyMode() {
  const disableButtonsText = ['ThÃªm', 'Ghi', 'XÃ³a'];
  const buttons = document.querySelectorAll('.btn');
  
  buttons.forEach(btn => {
    const text = btn.textContent || '';
    const isAction = disableButtonsText.some(t => text.includes(t)) && !text.includes('Táº£i') && !text.includes('Firebase');
    
    if (isAction) {
      btn.disabled = readOnlyMode;
      btn.style.opacity = readOnlyMode ? '0.5' : '1';
      btn.style.cursor = readOnlyMode ? 'not-allowed' : 'pointer';
    }
  });
  
  const deleteButtons = document.querySelectorAll('.delete-btn');
  deleteButtons.forEach(btn => {
    btn.disabled = readOnlyMode;
    btn.style.opacity = readOnlyMode ? '0.5' : '1';
    btn.style.cursor = readOnlyMode ? 'not-allowed' : 'pointer';
  });
}

function addMember() {
  const name = document.getElementById('memberName').value.trim();
  const type = document.getElementById('memberType').value;
  
  if (!name) {
    showNotification('Vui lÃ²ng nháº­p tÃªn VÄV', 'error');
    return;
  }
  
  if (members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
    showNotification('VÄV nÃ y Ä‘Ã£ cÃ³ trong danh sÃ¡ch', 'error');
    return;
  }
  
  members.push({ id: Date.now(), name, type });
  saveData();
  showNotification(`âœ“ ÄÃ£ thÃªm VÄV: ${name}`, 'success');
  document.getElementById('memberName').value = '';
  updateMembersList();
  updatePairSelects();
  autoSync();
}

function deleteMember(id) {
  if (confirm('XÃ³a VÄV nÃ y?')) {
    members = members.filter(m => m.id !== id);
    saveData();
    updateMembersList();
    updatePairSelects();
    showNotification('ÄÃ£ xÃ³a VÄV', 'success');
    autoSync();
  }
}

function updateMembersList() {
  const html = members.map(m => `
    <div class="member-item">
      <div><div class="member-name">${m.name}<span class="member-badge ${m.type === 'guest' ? 'guest' : ''}">${m.type === 'club' ? 'ThÃ nh ViÃªn' : 'KhÃ¡ch'}</span></div></div>
      <button class="delete-btn" onclick="deleteMember(${m.id})">XÃ³a</button>
    </div>
  `).join('') || '<div class="empty-state"><p>ChÆ°a cÃ³ thÃ nh viÃªn</p></div>';
  
  document.getElementById('membersList').innerHTML = html;
}

function addSchedule() {
  const dateInput = document.getElementById('scheduleDate').value.trim();
  const note = document.getElementById('scheduleNote').value.trim();
  
  if (!dateInput) {
    showNotification('Vui lÃ²ng nháº­p ngÃ y', 'error');
    return;
  }
  
  const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  const match = dateInput.match(dateRegex);
  
  if (!match) {
    showNotification('Äá»‹nh dáº¡ng ngÃ y khÃ´ng há»£p lá»‡ (dd/mm/yyyy)', 'error');
    return;
  }
  
  const [_, day, month, year] = match;
  const date = `${year}-${month}-${day}`;
  
  if (schedules.some(s => s.date === date)) {
    showNotification('NgÃ y nÃ y Ä‘Ã£ cÃ³ trong lá»‹ch', 'error');
    return;
  }
  
  schedules.push({ id: Date.now(), date, note, displayDate: dateInput });
  schedules.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  saveData();
  showNotification('âœ“ ÄÃ£ thÃªm ngÃ y sinh hoáº¡t', 'success');
  document.getElementById('scheduleDate').value = '';
  document.getElementById('scheduleNote').value = '';
  updateScheduleList();
  updateScheduleSelects();
  autoSync();
}

function deleteSchedule(id) {
  if (confirm('XÃ³a ngÃ y sinh hoáº¡t nÃ y?')) {
    schedules = schedules.filter(s => s.id !== id);
    saveData();
    updateScheduleList();
    updateScheduleSelects();
    showNotification('ÄÃ£ xÃ³a ngÃ y sinh hoáº¡t', 'success');
    autoSync();
  }
}

function updateScheduleList() {
  const html = schedules.map(s => {
    const dateStr = s.displayDate || new Date(s.date).toLocaleDateString('vi-VN');
    const matchCount = matches.filter(m => m.date === s.date).length;
    
    return `
      <div class="match-item">
        <div class="match-info">
          <div class="match-players"><strong>${dateStr}</strong></div>
          <div class="match-score">${s.note || 'KhÃ´ng cÃ³ ghi chÃº'} â€¢ ${matchCount} tráº­n</div>
        </div>
        <button class="delete-btn" onclick="deleteSchedule(${s.id})">XÃ³a</button>
      </div>
    `;
  }).join('') || '<div class="empty-state"><p>ChÆ°a cÃ³ lá»‹ch sinh hoáº¡t</p></div>';
  
  document.getElementById('scheduleList').innerHTML = html;
}

function updateScheduleSelects() {
  const select = document.getElementById('eventDate');
  const value = select.value;
  
  select.innerHTML = '<option value="">-- Chá»n ngÃ y --</option>' +
    schedules.map(s => `<option value="${s.date}">${s.displayDate || new Date(s.date).toLocaleDateString('vi-VN')}${s.note ? ` (${s.note})` : ''}</option>`).join('');
  
  if (value) select.value = value;
  updatePaymentDropdown();
}

function updatePaymentDropdown() {
  const select = document.getElementById('paymentDate');
  const value = select.value;
  
  select.innerHTML = '<option value="">-- Chá»n ngÃ y --</option>' +
    schedules.map(s => `<option value="${s.date}">${s.displayDate || new Date(s.date).toLocaleDateString('vi-VN')}${s.note ? ` (${s.note})` : ''}</option>`).join('');
  
  if (value) select.value = value;
}

function updatePairSelects() {
  const playerNames = members.map(m => m.name);
  const selectIds = ['pair1a', 'pair1b', 'pair2a', 'pair2b'];
  
  selectIds.forEach(id => {
    const elem = document.getElementById(id);
    const value = elem.value;
    
    elem.innerHTML = '<option value="">-- Chá»n --</option>' + playerNames.map(p => `<option value="${p}">${p}</option>`).join('');
    
    if (value) elem.value = value;
  });
}

function updateMatchForm() {
  if (!document.getElementById('eventDate').value) return;
}

function addMatch() {
  const date = document.getElementById('eventDate').value;
  const p1a = document.getElementById('pair1a').value;
  const p1b = document.getElementById('pair1b').value;
  const p2a = document.getElementById('pair2a').value;
  const p2b = document.getElementById('pair2b').value;
  const score1 = parseInt(document.getElementById('score1').value) || 0;
  const score2 = parseInt(document.getElementById('score2').value) || 0;
  
  if (!date) {
    showNotification('Vui lÃ²ng chá»n ngÃ y sinh hoáº¡t', 'error');
    return;
  }
  
  // Kiá»ƒm tra: má»—i cáº·p pháº£i chá»n Ã­t nháº¥t 1 VÄV
  const pair1Valid = p1a || p1b;
  const pair2Valid = p2a || p2b;
  
  if (!pair1Valid || !pair2Valid) {
    showNotification('Má»—i cáº·p pháº£i chá»n Ã­t nháº¥t 1 VÄV', 'error');
    return;
  }
  
  // Kiá»ƒm tra: cÃ¡c VÄV khÃ´ng Ä‘Æ°á»£c trÃ¹ng nhau
  const allPlayers = [p1a, p1b, p2a, p2b].filter(p => p);
  if (new Set(allPlayers).size !== allPlayers.length) {
    showNotification('CÃ¡c VÄV khÃ´ng Ä‘Æ°á»£c trÃ¹ng nhau', 'error');
    return;
  }
  
  const pair1 = [p1a, p1b].filter(p => p).join(' - ') || 'ChÆ°a xÃ¡c Ä‘á»‹nh';
  const pair2 = [p2a, p2b].filter(p => p).join(' - ') || 'ChÆ°a xÃ¡c Ä‘á»‹nh';
  
  matches.push({
    id: Date.now(),
    date,
    pair1,
    pair2,
    score1,
    score2,
    result1: score1 > score2 ? 'win' : 'lose',
    result2: score2 > score1 ? 'win' : 'lose'
  });
  
  saveData();
  showNotification(`âœ“ ThÃªm tráº­n: ${pair1} ${score1} - ${score2} ${pair2}`, 'success');
  
  document.getElementById('score1').value = '';
  document.getElementById('score2').value = '';
  document.getElementById('pair1a').value = '';
  document.getElementById('pair1b').value = '';
  document.getElementById('pair2a').value = '';
  document.getElementById('pair2b').value = '';
  
  updateMatchList();
  updatePaymentList();
  autoSync();
}

function updateMatchList() {
  const dateFilter = document.getElementById('eventDate').value;
  const filtered = dateFilter ? matches.filter(m => m.date === dateFilter) : matches;
  
  const html = filtered.slice().reverse().map(m => `
    <div class="match-item">
      <div class="match-info">
        <div class="match-players">${m.pair1} <strong>${m.score1}</strong> - <strong>${m.score2}</strong> ${m.pair2}</div>
        <div class="match-score">${m.date}</div>
      </div>
      <button class="delete-btn" onclick="deleteMatch(${m.id})">XÃ³a</button>
    </div>
  `).join('') || '<div class="empty-state"><p>ChÆ°a cÃ³ tráº­n Ä‘áº¥u</p></div>';
  
  document.getElementById('matchList').innerHTML = html;
}

function deleteMatch(id) {
  if (confirm('XÃ³a tráº­n Ä‘áº¥u nÃ y?')) {
    matches = matches.filter(m => m.id !== id);
    saveData();
    updateMatchList();
    updatePaymentList();
    showNotification('ÄÃ£ xÃ³a tráº­n Ä‘áº¥u', 'success');
    autoSync();
  }
}

function updatePaymentList() {
  const date = document.getElementById('paymentDate').value;
  
  if (!date) {
    document.getElementById('paymentList').innerHTML = '<div class="empty-state"><p>Vui lÃ²ng chá»n ngÃ y</p></div>';
    return;
  }
  
  const dayMatches = matches.filter(m => m.date === date);
  const playerMoney = {};
  
  dayMatches.forEach(m => {
    const pair1Players = m.pair1.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    const pair2Players = m.pair2.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    
    if (m.result1 === 'win') {
      pair1Players.forEach(p => playerMoney[p] = (playerMoney[p] || 0) + 50);
      pair2Players.forEach(p => playerMoney[p] = (playerMoney[p] || 0) - 50);
    } else {
      pair2Players.forEach(p => playerMoney[p] = (playerMoney[p] || 0) + 50);
      pair1Players.forEach(p => playerMoney[p] = (playerMoney[p] || 0) - 50);
    }
  });
  
  if (Object.keys(playerMoney).length === 0) {
    document.getElementById('paymentList').innerHTML = '<div class="empty-state"><p>ChÆ°a cÃ³ tráº­n Ä‘áº¥u ngÃ y nÃ y</p></div>';
    return;
  }
  
  const sorted = Object.entries(playerMoney).sort((a, b) => a[1] - b[1]);
  const total = Object.values(playerMoney).reduce((a, b) => a + b, 0);
  
  let html = `<div class="payment-date-header">ğŸ“… ${new Date(date).toLocaleDateString('vi-VN')}</div>`;
  
  html += sorted.map(([name, amount]) => `
    <div class="payment-item">
      <div class="payment-name">${name}</div>
      <div><span class="money ${amount < 0 ? 'negative' : 'positive'}">${amount < 0 ? '-' : '+'}${Math.abs(amount)}k</span></div>
    </div>
  `).join('');
  
  html += `<div class="total-payment"><div class="total-payment-label">Tá»•ng Cá»™ng</div><div class="total-payment-value">${total >= 0 ? '+' : ''}${total}k</div></div>`;
  
  document.getElementById('paymentList').innerHTML = html;
}

function updateRankingMoney() {
  const currentYear = new Date().getFullYear();
  const playerMoney = {};
  
  matches.forEach(m => {
    if (new Date(m.date).getFullYear() !== currentYear) return;
    
    const pair1Players = m.pair1.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    const pair2Players = m.pair2.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    
    if (m.result1 === 'win') {
      pair1Players.forEach(p => {
        playerMoney[p] = playerMoney[p] || { money: 0, matches: 0 };
        playerMoney[p].money += 50;
        playerMoney[p].matches++;
      });
      pair2Players.forEach(p => {
        playerMoney[p] = playerMoney[p] || { money: 0, matches: 0 };
        playerMoney[p].money -= 50;
        playerMoney[p].matches++;
      });
    } else {
      pair2Players.forEach(p => {
        playerMoney[p] = playerMoney[p] || { money: 0, matches: 0 };
        playerMoney[p].money += 50;
        playerMoney[p].matches++;
      });
      pair1Players.forEach(p => {
        playerMoney[p] = playerMoney[p] || { money: 0, matches: 0 };
        playerMoney[p].money -= 50;
        playerMoney[p].matches++;
      });
    }
  });
  
  const sorted = Object.entries(playerMoney).sort((a, b) => b[1].money - a[1].money);
  const tbody = document.getElementById('rankingMoneyBody');
  
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
    return;
  }
  
  tbody.innerHTML = sorted.map(([name, data], i) => `
    <tr>
      <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
      <td>${name}</td>
      <td>${data.matches}</td>
      <td><span class="money ${data.money >= 0 ? 'positive' : 'negative'}">${data.money >= 0 ? '+' : ''}${data.money}k</span></td>
    </tr>
  `).join('');
}

function updateRankingSkill() {
  const playerStats = {};
  
  matches.forEach(m => {
    const pair1Players = m.pair1.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    const pair2Players = m.pair2.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    
    const allPlayers = [...pair1Players, ...pair2Players];
    
    allPlayers.forEach(name => {
      if (!playerStats[name]) playerStats[name] = { wins: 0, matches: 0 };
      
      playerStats[name].matches++;
      
      if ((m.pair1.includes(name) && m.result1 === 'win') || (m.pair2.includes(name) && m.result2 === 'win')) {
        playerStats[name].wins++;
      }
    });
  });
  
  const filtered = Object.entries(playerStats)
    .filter(([_, s]) => s.matches >= 5)
    .sort((a, b) => (b[1].wins / b[1].matches) - (a[1].wins / a[1].matches));
  
  const tbody = document.getElementById('rankingSkillBody');
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">ChÆ°a cÃ³ VÄV â‰¥5 tráº­n</td></tr>';
    return;
  }
  
  tbody.innerHTML = filtered.map(([name, stats], i) => {
    const wr = ((stats.wins / stats.matches) * 100).toFixed(1);
    
    return `
      <tr>
        <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
        <td>${name}</td>
        <td>${stats.matches}</td>
        <td>${wr}%</td>
      </tr>
    `;
  }).join('');
}

function updateRankingScore() {
  const playerScore = {};
  
  matches.forEach(m => {
    const pair1Players = m.pair1.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    const pair2Players = m.pair2.split(' - ').map(x => x.trim()).filter(x => x !== 'ChÆ°a xÃ¡c Ä‘á»‹nh');
    
    if (m.result1 === 'win') {
      pair1Players.forEach(p => {
        playerScore[p] = playerScore[p] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 };
        playerScore[p].score += 1;
        playerScore[p].wins++;
        playerScore[p].totalScore1 += m.score1;
        playerScore[p].totalScore2 += m.score2;
      });
      pair2Players.forEach(p => {
        playerScore[p] = playerScore[p] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 };
        playerScore[p].score -= 1;
        playerScore[p].losses++;
        playerScore[p].totalScore1 += m.score2;
        playerScore[p].totalScore2 += m.score1;
      });
    } else {
      pair2Players.forEach(p => {
        playerScore[p] = playerScore[p] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 };
        playerScore[p].score += 1;
        playerScore[p].wins++;
        playerScore[p].totalScore1 += m.score2;
        playerScore[p].totalScore2 += m.score1;
      });
      pair1Players.forEach(p => {
        playerScore[p] = playerScore[p] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 };
        playerScore[p].score -= 1;
        playerScore[p].losses++;
        playerScore[p].totalScore1 += m.score1;
        playerScore[p].totalScore2 += m.score2;
      });
    }
  });
  
  const sorted = Object.entries(playerScore).sort((a, b) => b[1].score - a[1].score);
  const tbody = document.getElementById('rankingScoreBody');
  
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
    return;
  }
  
  tbody.innerHTML = sorted.map(([name, data], i) => {
    const scoreDiff = data.totalScore1 - data.totalScore2;
    
    return `
      <tr>
        <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
        <td>${name}</td>
        <td>${data.wins}/${data.losses}</td>
        <td><span class="money ${data.score >= 0 ? 'positive' : 'negative'}">${data.score >= 0 ? '+' : ''}${data.score}Ä‘</span></td>
        <td><span class="money ${scoreDiff >= 0 ? 'positive' : 'negative'}">${scoreDiff >= 0 ? '+' : ''}${scoreDiff}</span></td>
      </tr>
    `;
  }).join('');
}

async function manualSaveFirebase() {
  setSyncLoading(true);
  try {
    await set(ref(database, 'Ali33'), {
      members,
      schedules,
      matches,
      adminPassword,
      readOnlyMode: true,
      lastSync: new Date().toISOString()
    });
    setSyncLoading(false);
    showNotification('âœ… LÆ°u Firebase thÃ nh cÃ´ng!', 'success');
  } catch (e) {
    setSyncLoading(false);
    showNotification('âŒ LÆ°u tháº¥t báº¡i', 'error');
  }
}

async function manualLoadFirebase() {
  setSyncLoading(true);
  try {
    const snapshot = await get(ref(database, 'Ali33'));
    if (snapshot.exists()) {
      const data = snapshot.val();
      members = data.members || [];
      schedules = data.schedules || [];
      matches = data.matches || [];
      adminPassword = data.adminPassword || 'Ali33';
      saveData();
      localStorage.setItem('adminPassword', adminPassword);
      
      updateMembersList();
      updatePairSelects();
      updateScheduleList();
      updateScheduleSelects();
      updateMatchList();
      applyReadOnlyMode();
      updateSettingsUI();
      
      setSyncLoading(false);
      showNotification('âœ… Táº£i Firebase thÃ nh cÃ´ng!', 'success');
    } else {
      setSyncLoading(false);
      showNotification('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u', 'info');
    }
  } catch (e) {
    setSyncLoading(false);
    showNotification('âŒ Táº£i tháº¥t báº¡i', 'error');
  }
}

async function autoSync() {
  try {
    await set(ref(database, 'Ali33'), {
      members,
      schedules,
      matches,
      adminPassword,
      readOnlyMode: true,
      lastSync: new Date().toISOString()
    });
  } catch (e) {}
}

function setSyncLoading(loading) {
  const status = document.getElementById('syncStatus');
  const text = document.getElementById('syncText');
  
  if (loading) {
    status.classList.add('loading');
    text.textContent = 'Äang Ä‘á»“ng bá»™...';
  } else {
    status.classList.remove('loading');
    text.textContent = 'Sáºµn sÃ ng Ä‘á»“ng bá»™';
  }
}

window.toggleAutoSync = function() {
  showNotification('âœ… Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ luÃ´n báº­t', 'info');
};

window.toggleReadOnlyWithPassword = toggleReadOnlyWithPassword;
window.manualSaveFirebase = manualSaveFirebase;
window.manualLoadFirebase = manualLoadFirebase;
window.switchTab = switchTab;
window.addMember = addMember;
window.deleteMember = deleteMember;
window.addSchedule = addSchedule;
window.deleteSchedule = deleteSchedule;
window.updateMatchForm = updateMatchForm;
window.addMatch = addMatch;
window.deleteMatch = deleteMatch;
window.updatePaymentList = updatePaymentList;

window.exportData = function() {
  const data = JSON.stringify({ members, schedules, matches }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Ali33-data.json';
  a.click();
  showNotification('âœ… Táº£i vá» thÃ nh cÃ´ng!', 'success');
};

window.clearAllData = function() {
  if (!confirm('âš ï¸ XÃ³a táº¥t cáº£? (khÃ´ng thá»ƒ hoÃ n tÃ¡c)')) return;
  
  members = [];
  schedules = [];
  matches = [];
  saveData();
  
  updateMembersList();
  updateScheduleList();
  updateMatchList();
  document.getElementById('paymentList').innerHTML = '';
  document.getElementById('rankingMoneyBody').innerHTML = '<tr><td colspan="4" class="empty-state">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
  document.getElementById('rankingSkillBody').innerHTML = '<tr><td colspan="4" class="empty-state">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
  document.getElementById('rankingScoreBody').innerHTML = '<tr><td colspan="5" class="empty-state">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
  
  showNotification('ÄÃ£ xÃ³a táº¥t cáº£', 'success');
  autoSync();
};

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

function saveData() {
  localStorage.setItem('members', JSON.stringify(members));
  localStorage.setItem('schedules', JSON.stringify(schedules));
  localStorage.setItem('matches', JSON.stringify(matches));
}

// Init
updateMembersList();
updatePairSelects();
updateScheduleList();
updateScheduleSelects();
updateMatchList();
document.getElementById('autoSyncBtn').textContent = 'âœ… Tá»± Äá»™ng Äá»“ng Bá»™ (Báº¬T)';
applyReadOnlyMode();
updateSettingsUI();

window.addEventListener('load', () => {
  setTimeout(() => manualLoadFirebase(), 500);
});

</script>

</body>
</html>
